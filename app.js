require('dotenv').config()
const axios = require('axios')
const { EVENTS } = require('@bot-whatsapp/bot')

const { createBot, createProvider, createFlow, addKeyword, addAnswer } = require('@bot-whatsapp/bot')

const QRPortalWeb = require('@bot-whatsapp/portal')
const BaileysProvider = require('@bot-whatsapp/provider/baileys')
const MockAdapter = require('@bot-whatsapp/database/mock')

/**
 * 
 * 
 * 
 * 
 
const menuAPI = async () => {
    const config = {
        method: 'get',
        url: 'https://intertel.online/api/v1/GetClientsDetails',
        headers: {
            'Authorization': `Bearer ${process.env.MIKRO_API}`
        }
    };
    const {data} = await axios(config).then((i) => i.data)
    return data.map(m =>
    ({
        body:[`*DNI: ${m.attibutes.cedula}:*Telefono: ${m.attributtes.telefono}`].join('\n')
    }))
}

*/

/////////// FLUJOS DE COSTOS - OK ///////////////
const flowCostos = addKeyword('1')

        .addAnswer('üëâ *PLAN_BASICO* - Conexion recomendada para 3 dispositivos simultaneos - $8.000 x mes')
        .addAnswer('üëâ *PLAN_PREMIUM* - Recomendado para 5 dispositivos simultaneos - $10.000 x mes')
        .addAnswer('üëâ *PLAN_FULL* - Velocidad de hasta 15 Megas Simetricos- Compartido - $12.000 x mes')
        .addAnswer('üëâ *PLAN_FTTC_BASICO* - Conexion recomendada para 5 dispositivos simultaneos - $9.000 x mes')
        .addAnswer('üëâ *PLAN_FTTC_PREMIUM* - Conexion recomendada para MULTIPLES dispositivos  - $11.000 x mes')
        .addAnswer('üëâ *PLAN_FTTC_FULL* - Conexion de hasta 20 Megas Simetricos - Compartidos - $13.000 x mes')
                

        .addAnswer('üí∞ Costo de la instalacion $90.000')
        .addAnswer('*INCLUYE EN COMODATO*')

        .addAnswer('üßø *IMPORTANTE*',
                    'Para corroborar la disponibilidad del servicio debe enviarnos las coordenadas de Google Maps al Whatsapp, solicitar hablar con un asesor',
                    
                 )
                 .addAnswer ('Para continuar *esbriba el numero* de la opcion que necesita')
                // .addAnswer('1Ô∏è‚É£ *Portal de Cliente*')
                 .addAnswer('0Ô∏è‚É£ *Volver al menu anterior*',
         
                                 {capture: true},
                                 async (ctx, {gotoFlow}) => {
                                     const body = ctx.body;
                                     if (body === "0") 
                                     return gotoFlow(flowInformacion)
                             }
                                  )

/////////////////////////////////// FLUJO DE ASESOR ///////////////////////////////////////////////////

const flowAsesor = addKeyword('2')

.addAnswer('ü§ñ Un asesor t√©cnico se pondr√° en contacto con ud dentro de nuestros horarios de atenci√≥n: lunes a viernes 9Hs a 19hs. Muchas Gracias')

.addAnswer('0Ô∏è‚É£ *Volver al menu anterior*')


////////////////////////////// FLUJO PARA SOLICITAR EL SERVICIO ////////////////////////////////////

const flowSolicitarServicio = addKeyword('3')

.addAnswer('*Solicitar nuevo servicio*')
.addAnswer(' Pediremos tus datos y daremos de alta tu cuenta de cliente')
.addAnswer(' Cuando la cuenta este dada de alta te va a llegar un mensaje de bienvenida, y despu√©s un segundo mensaje confirmando d√≠a y hora de la instalaci√≥n. Los tiempos de instalaci√≥n son entre 24hs y 72hs. Muchas gracias!')
.addAnswer('0Ô∏è‚É£ *Para cancelar y ver el menu nuevamente*')
.addAnswer('1Ô∏è‚É£ *Para continuar')


/////////////// FlUJO DE CLIENTE //////////////////////

/**
 * 
 * 
 * 
 * 
 
const menuAPI = async () => {
    const config = {
        method: 'get',
        url: 'https://intertel.online/api/v1/GetClientsDetails',
        headers: {
            'Authorization': `Bearer ${process.env.MIKRO_API}`
        }
    };
    const {data} = await axios(config).then((i) => i.data)
    return data.map(m =>
    ({
        body:[`*DNI: ${m.attibutes.cedula}:*Telefono: ${m.attributtes.telefono}`].join('\n')
    }))
}




const flowCliente = addKeyword('2')
    .addAction (async (_, { flowDynamic }) => {
            return flowDynamic ('‚û° Ingrese el DNI del titular *SIN PUNTO, NI ESPACIOS* ...')
    })

    .addAction({ capture: true }, async (ctx, { flowDynamic, state }) => {
        await state.update({ cedula: ctx.body }); // Actualiza el estado con el DNI ingresado
        const dni = ctx.body.trim().replace(/\./g, ''); // Elimina puntos del DNI
        try {
            const response = await axios.get(`https://intertel.online/api/v1/GetClientsDetails/${cedula}`); // Realiza la solicitud a la API con el DNI
            const { nombre, estado } = response.data; // Extrae nombre y tel√©fono de la respuesta
            await state.update({ nombre, estado }); // Actualiza el estado con nombre y tel√©fono
            return flowDynamic(`Nombre: ${nombre}, Estado: ${estado}`);
        } catch (error) {
            console.error('Error al obtener datos del cliente:', error);
            return flowDynamic('En este momento la conexi√≥n con la base de datos no est√° disponible üî¥. Int√©ntelo m√°s tarde. Gracias');
        }
    })
    .addAnswer('Tu datos de cliente son: ', null, async (ctx, { flowDynamic, state }) => {
        // Accede al estado para obtener nombre y tel√©fono
        const { nombre, telefono } = await state.load();
        if (nombre && telefono) {
            return flowDynamic(`Nombre: ${nombre}, Tel√©fono: ${telefono}`);
        } else {
            return flowDynamic('Los datos del cliente no est√°n disponibles en este momento. Int√©ntelo m√°s tarde.');
        }
    });

    /*
    .addAction({ capture: true }, async (ctx, { flowDynamic, state }) => {
        await state.update({ name: ctx.body })
        return flowDynamic(`Tu DNI es : ${ctx.body}`)
    })
    .addAnswer('En este momento la conexion con la base de datos no esta disponible üî¥. Intentelo mas tarde! Gracias', {
        delay:1500,
    })
    .addAnswer('Tu datos de cliente son: ', null, async (ctx, {flowDynamic}) => {
        const data = await menuAPI()
        return flowDynamic(data);
    }
)


    .addAnswer('0Ô∏è‚É£ *Volver Al Menu Principal*',
         
                                 {capture: true},
                                 async (ctx, {gotoFlow}) => {
                                     const body = ctx.body;
                                     if (body === "0") 
                                     return gotoFlow(flowComienzo)
                             })

    


*/
//const axios = require('axios'); // Aseg√∫rate de tener Axios instalado en tu proyecto

const menuAPI = async () => {
    const config = {
        method: 'get',
        url: 'https://intertel.online/api/v1/GetClientsDetails',
        headers: {
            'Authorization': `Bearer ${process.env.MIKRO_API}`
        }
    };
    try {
        const response = await axios(config);
        const { data } = response;
        
        // Comprueba si data es un array
        if (Array.isArray(data)) {
            // Si es un array, mapea los elementos y retorna el resultado
            return data.map(m =>
                ({
                    body: `*DNI: ${m.attributes.cedula}*\nTel√©fono: ${m.attributes.telefono}`
                }));
        } else {
            // Si no es un array, retorna un mensaje indicando que la estructura no es v√°lida
            return [{ body: 'La estructura de datos no es v√°lida.' }];
        }
    } catch (error) {
        console.error('Error al obtener datos del cliente:', error);
        throw error; // Lanza el error para que sea manejado externamente
    }
};

const flowCliente = addKeyword('2')
    .addAction(async (_, { flowDynamic }) => {
        return flowDynamic('‚û° Ingrese el DNI del titular *SIN PUNTO, NI ESPACIOS* ...');
    })
    .addAction({ capture: true }, async (ctx, { flowDynamic, state }) => {
        const dni = ctx.body.trim().replace(/\./g, ''); // Elimina puntos del DNI
        try {
            const data = await menuAPI(); // Obt√©n los detalles del cliente utilizando la funci√≥n menuAPI
            const clientDetails = data.find(item => item.body.includes(`*DNI: ${cedula}:`)); // Encuentra los detalles del cliente correspondientes al DNI ingresado
            if (clientDetails) {
                return flowDynamic(clientDetails.body);
            } else {
                return flowDynamic('No se encontraron detalles para el DNI proporcionado.');
            }
        } catch (error) {
            console.error('Error al obtener datos del cliente:', error);
            return flowDynamic('En este momento la conexi√≥n con la base de datos no est√° disponible üî¥. Int√©ntelo m√°s tarde. Gracias');
        }
    });



const flowComprobante = addKeyword('3')
    .addAnswer('‚û° Para enviar tu comprobante de pago lo podes hacer desde el *Portal de Cliente*')
    .addAnswer('¬øComo puedo hacerlo ?, muy facil. Con tu  E-mail y contrase√±a que se envia al momento de realizar la instalacion de servicio te logueas en  ')
    .addAnswer('Recibimos su comprobante, el mismo ser√° imputado dentro de nuestros horarios de atenci√≥n (lunes a viernes 9Hs a 17hs). Si no est√° enviando comprobante, un asesor se comunicar√° con Ud. Muchas gracias.')
   
  
const flowInformacion = addKeyword('1')
        .addAnswer(['1Ô∏è‚É£ *Costo de conexion y planes*',
                    '2Ô∏è‚É£ *Hablar con un asesor*',
                    '3Ô∏è‚É£ *Costo de conexion y planes*',
                    '0Ô∏è‚É£ *Volver Al Menu Principal*',
        ],
      
        {capture:true},
        async (ctx, {gotoFlow}) => {
            const body = ctx.body;
            if(body === "0") return gotoFlow(flowComienzo);
        },

         
            [flowCostos, flowSolicitarServicio, flowAsesor]
        )
       // .addAnswer('0Ô∏è‚É£ *Volver Al Menu Principal*')


const flowComienzo = addKeyword('UBNT', { sensitive: true })
    .addAnswer('üôå Hola gracias por comunicarte con  *Intertel Comunicaciones*')
   // {capture:true},(ctx) => {
     //   console.log('Inicio de Mensaje: ',ctx)
  //  })
    .addAnswer('Escribe un *EL NUMERO*  de la opcion deseada:')
    .addAnswer(
        [
            '1Ô∏è‚É£ *QUIERO INFORMACION*',
            '2Ô∏è‚É£ *SOY CLIENTE* ',
            '3Ô∏è‚É£ *ENVIO DE COMPROBANTE*',
            '*Recorda escribir el n√∫mero y darle enviar, mensajes de audio y fotos ser√°n ignorados. Gracias!*'
           
        ],null,null,[flowInformacion,flowCliente,flowComprobante]
    )
    



const main = async () => {
    const adapterDB = new MockAdapter()
    const adapterFlow = createFlow([flowComienzo])
    const adapterProvider = createProvider(BaileysProvider)

    createBot({
        flow: adapterFlow,
        provider: adapterProvider,
        database: adapterDB,
    })

    QRPortalWeb()
}

main()
